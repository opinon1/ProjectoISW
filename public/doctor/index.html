<!DOCTYPE html>
<html lang="en">
  <head>
    <!--Metadata-->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor</title>

    <!--Estilos bootstrap-->
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />

    <!--Iconos-->
    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <!--Cripto -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"
    ></script>

    <!-- Axios (Para peticiones HTTP) -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>

  <!--Generador de HASH -->
  <script>
    const cyrb53 = (str, seed = 0) => {
      let h1 = 0xdeadbeef ^ seed,
        h2 = 0x41c6ce57 ^ seed;
      for (let i = 0, ch; i < str.length; i++) {
        ch = str.charCodeAt(i);
        h1 = Math.imul(h1 ^ ch, 2654435761);
        h2 = Math.imul(h2 ^ ch, 1597334677);
      }
      h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507);
      h1 ^= Math.imul(h2 ^ (h2 >>> 13), 3266489909);
      h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507);
      h2 ^= Math.imul(h1 ^ (h1 >>> 13), 3266489909);

      return 4294967296 * (2097151 & h2) + (h1 >>> 0);
    };
  </script>

  <!--Contenido visible-->
  <body>
    <!--Barra de navegacion-->
    <div class="sidebar">
      <div class="dots">
        <h3>Kokua</h3>
      </div>

      <div class="profile">
        <ion-icon name="person-outline"></ion-icon>
      </div>

      <ul>
        <span>Principal</span>
        <li>
          <a href="./index.html#homeContent">
            <ion-icon name="home-outline"></ion-icon>
            <p>Inicio</p>
          </a>
        </li>
        <li>
          <a href="#notifications">
            <ion-icon name="notifications-outline"></ion-icon>
            <p>Avisos</p>
          </a>
        </li>
      </ul>

      <ul>
        <span>Contenido</span>
        <li>
          <a href="#patients">
            <ion-icon name="accessibility-outline"></ion-icon>
            <p>Mis pacientes</p>
          </a>
        </li>
        <li class="likes">
          <a href="#update">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <p>Progreso medico</p>
          </a>
        </li>
        <li>
          <a href="#profile">
            <ion-icon name="person-circle-outline"></ion-icon>
            <p>Perfil</p>
          </a>
        </li>
      </ul>

      <ul>
        <span>Sesión</span>
        <li>
          <a href="https://www.kokuahealth.tech/">
            <ion-icon name="log-out-outline"></ion-icon>
            <p>Salir</p>
          </a>
        </li>
      </ul>
    </div>
    <!--Fin de la barra de navegacion-->

    <!--Seccion 1 de navegacion-->
    <div class="main-content">
      <!--Pagina principal-->
      <div id="homeContent" class="content">
        <div class="main">
          <div class="row">
            <div class="col-sm-6 text-center">
              <h4 class="display-4" style="font-weight: lighter">
                ¡Bienvenido Doctor!
              </h4>
              <br />
              <div
                class="jumbotron p-4 mx-auto w-50"
                style="background-color: #6275e6; color: #fff"
              >
                <h1>SIGAMOS AYUDANDO</h1>
                <h2 style="font-weight: lighter">A TODO EL MUNDO</h2>
              </div>
              <br />
              <div class="textoHospital">
                <p class="textoH">
                  <u>Tu dedicación ilumina caminos hacia la curación</u>
                </p>
                <p class="textoHU">
                  <u
                    >Eres la inspiración que guía la esperanza en cada
                    diagnóstico</u
                  >
                </p>
              </div>
            </div>
            <div class="col-sm-6">
              <img
                src="https://d2lcsjo4hzzyvz.cloudfront.net/blog/wp-content/uploads/2019/12/Me%CC%81dico-atendiendo-a-una-sen%CC%83ora-de-edad.jpg"
                class="imgDoctor img-fluid"
              />
            </div>
          </div>
        </div>
      </div>

      <!--Notificaciones-->
      <div id="notifications" class="content">
        <div class="main">
          <div class="row">
            <div class="col-sm-12 text-left">
              <h1>
                <ion-icon name="notifications-outline"></ion-icon>
                Mis notificaciones
              </h1>
              <p>Hola Doctor, aquí se muestran tus notificaciones.</p>
              <br />

              <h3>
                <ion-icon name="calendar-outline"></ion-icon>
                Mis citas
              </h3>
              <br />

              <button
                class="collapseButton"
                data-toggle="collapse"
                data-target="#appointmentFormCointainer"
              >
                Nueva cita
              </button>
              <div id="appointmentFormCointainer" class="collapse">
                <form id="appointmentForm" class="appointmentForm">
                  <label>ID Paciente: &emsp;</label>
                  <input
                    id="Citas-ID_Paciente"
                    type="text"
                    placeholder="ID del paciente"
                  />
                  <br />
                  <label>Fecha: &emsp;</label>
                  <input id="Citas-Fecha" type="date" />
                  <br />
                  <label>Tipo: &emsp;</label>
                  <select id="Citas-Tipo">
                    <option value="Estandar">Estandar</option>
                    <option value="DePrueba">DePrueba</option>
                  </select>
                  <br />
                  <div class="d-flex justify-content-between">
                    <p id="Citas-Mensaje" class="warningMessage"></p>
                    <button type="button" onclick="newAppointment()">
                      Crear cita
                    </button>
                  </div>
                </form>
              </div>

              <div
                id="Appointments"
                class="col-sm-12 text-left"
                style="max-height: 250px; overflow-y: scroll"
              >
                <br />

                <!-- Indicador de valores de cada columna -->
                <div
                  class="d-flex justify-content-between"
                  style="width: 800px"
                >
                  <p style="width: 160px"><b>Paciente</b></p>
                  <p style="width: 160px"><b>&emsp;Fecha</b></p>
                  <p style="width: 160px"><b>&emsp;Tipo</b></p>
                  <p style="width: 160px"><b>&emsp;Estatus</b></p>
                  <p style="width: 160px"></p>
                </div>

                <!--Carga y muestra las citas-->
                <script>
                  //Señalan a donde debe añadir las nuevas citas
                  const container = document.getElementById("Appointments");
                  const appointmentCointainerClass = "card";
                  const cardWidth = 800;

                  const appointmentURL = "/api/doctor/appointments/:id";
                  const idDoctor = 2; // El ID que quieres usar
                  const updateAppointmentURL = appointmentURL.replace(
                    ":id",
                    idDoctor
                  );

                  function loadJSON(url) {
                    return fetch(url)
                      .then((response) => {
                        if (!response.ok) {
                          throw new Error(`Error de red: ${response.status}`);
                        }
                        return response.json();
                      })
                      .catch((error) => {
                        console.error(
                          `Error al cargar JSON desde ${url}:`,
                          error
                        );
                        throw error; // Relanzar el error para manejo posterior si es necesario
                      });
                  }

                  async function agregarCita(datosCita) {
                    try {
                      const response = await fetch("/api/doctor/appointments", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify(datosCita),
                      });

                      if (!response.ok) {
                        throw new Error(
                          `HTTP error! status: ${response.status}`
                        );
                      }

                      const data = await response.json();
                      console.log(
                        "Cita agregada con éxito, ID:",
                        data.insertedId
                      );
                      return data.insertedId; // Devolver el ID de la cita insertada
                    } catch (error) {
                      console.error("Error al agregar la cita:", error);
                    }
                  }

                  const newAppointment = async () => {
                    //Para insertar mensajes de error
                    const formularioCita =
                      document.getElementById("appointmentForm");

                    //Controladores de los inputs
                    const date = document.getElementById("Citas-Fecha");
                    const type = document.getElementById("Citas-Tipo");
                    const patientID =
                      document.getElementById("Citas-ID_Paciente");

                    //Controlador del mensaje de error
                    const errorMessage =
                      document.getElementById("Citas-Mensaje");

                    //Si los campos estan llenos
                    if (date.value && type.value && patientID.value) {
                      const response = await loadJSON(updateAppointmentURL);
                      const appointments = response.data;
                      //console.log(appointments[0].IDDoctor);
                      const jsonAppointment = {
                        IDPaciente: patientID.value,
                        IDDoctor: idDoctor,
                        TipoCita: type.value,
                        EstatusCita: "Agendada",
                        Fecha: date.value,
                      };
                      agregarCita(jsonAppointment).then((insertedId) => {
                        if (insertedId) {
                          const newAppointment = document.createElement("div");
                          newAppointment.className = appointmentCointainerClass;
                          newAppointment.style = `width: ${cardWidth}px`;
                          newAppointment.id = "Cita-" + insertedId;
                          newAppointment.innerHTML = `
                                                        <div class="d-flex justify-content-around" style="width:${cardWidth}px">
                                                            <p style="width:${
                                                              cardWidth / 5
                                                            }px">Jose Jimenez</p> 
                                                            <p style="width:${
                                                              cardWidth / 5
                                                            }px">${
                            date.value
                          }</p>
                                                            <p style="width:${
                                                              cardWidth / 5
                                                            }px">${
                            type.value
                          }</p>
                                                            <p style="width:${
                                                              cardWidth / 5
                                                            }px">Por confirmar</p>
                                                            <button onclick="deleteAppointment(${insertedId})" class="cancelButton">Cancelar cita</button>
                                                        </div>
                                                    `;
                          container.appendChild(newAppointment);

                          date.value = "";
                          type.value = "";
                          patientID.value = "";
                        }
                      });
                    } else {
                      errorMessage.innerHTML = "Rellene todos los campos";
                    }
                  };
                  async function eliminarCita(idCita) {
                    try {
                      const response = await fetch(
                        "/api/paciente/appointments/" + idCita,
                        {
                          method: "DELETE",
                        }
                      );

                      if (!response.ok) {
                        throw new Error(
                          `HTTP error! status: ${response.status}`
                        );
                      }

                      const data = await response.json();
                      console.log(data.message);
                      // Aquí puedes manejar la respuesta, como actualizar la interfaz de usuario
                    } catch (error) {
                      console.error("Error al eliminar la cita:", error);
                    }
                  }

                  const deleteAppointment = async (appointmentID) => {
                    await eliminarCita(appointmentID);
                    const child = document.getElementById(
                      "Cita-" + appointmentID
                    );
                    container.removeChild(child);
                  };

                  const loadAppointments = async () => {
                    const response = await loadJSON(updateAppointmentURL);
                    const appointments = response.data;
                    appointments.map((appointment) => {
                      const patientDiv = document.createElement("div");
                      patientDiv.className = appointmentCointainerClass;
                      patientDiv.style = `width: ${cardWidth}px`;
                      patientDiv.id = "Cita-" + appointment.IDCita;
                      patientDiv.innerHTML = `
                                            <div class="d-flex justify-content-around" style="width:${cardWidth}px">
                                            <p style="width:${
                                              cardWidth / 5
                                            }px">${
                        appointment.Nombre + " " + appointment.Apellido
                      }</p> 
                                            <p style="width:${
                                              cardWidth / 5
                                            }px">${appointment.Fecha}</p>
                                            <p style="width:${
                                              cardWidth / 5
                                            }px">${appointment.TipoCita}</p>
                                            <p style="width:${
                                              cardWidth / 5
                                            }px">${appointment.EstatusCita}</p>
                                            <button onclick="deleteAppointment(${
                                              appointment.IDCita
                                            })" class="cancelButton">Cancelar cita</button></div>
                                            `;
                      container.appendChild(patientDiv);
                    });
                  };

                  loadAppointments();
                </script>
              </div>
              <br />
              <br />

              <h3>
                <ion-icon name="bookmarks-outline"></ion-icon>
                Mis eventos
              </h3>
              <br />

              <div id="Events" class="col-sm-12 text-left">
                <div id="AvailableEvents">
                  <h5>&emsp;Eventos disponibles</h5>
                  <div
                    id="AvailableEventsContainer"
                    style="width: 920px; height: 330px; overflow: auto"
                  ></div>
                </div>
                <br />

                <div id="MyEvents">
                  <h5>&emsp;Eventos programados</h5>
                  <div
                    id="MyEventsContainer"
                    style="width: 920px; height: 330px; overflow: auto"
                  ></div>
                </div>

                <script>
                  /* Contenedores de los eventos */
                  const availableEventsContainer = document.getElementById(
                    "AvailableEventsContainer"
                  );
                  const myEventsContainer =
                    document.getElementById("MyEventsContainer");

                  const eventClassName = "card";

                  let availableEvents = [
                    /*   ID         Nombre              Lugar       Fecha            Descripcion                        Estatus*/
                    [
                      "1",
                      "Reunion de doctores",
                      "Auditorio",
                      "2024-01-01",
                      "Todos los doctores de Kokua se veran",
                      "Pospuesto",
                    ],
                    [
                      "3",
                      "Conoce a Julion Alvarez",
                      "Auditorio",
                      "2024-01-03",
                      "Concierto de Julion",
                      "A tiempo",
                    ],
                    [
                      "4",
                      "Conoce nuestros procesos",
                      "RR.HH",
                      "2024-01-04",
                      "Conoceras el proceso administrativo que tenemos",
                      "A tiempo",
                    ],
                    [
                      "6",
                      "Visita escolar: UP",
                      "Auditorio",
                      "2024-01-06",
                      "Vendran alumnos de la UP a conocernos",
                      "A tiempo",
                    ],
                  ];

                  let myEvents = [
                    [
                      "2",
                      "Convivencia con pacientes",
                      "Patio",
                      "2024-01-02",
                      "Todos los doctores conviviran con sus pacientes",
                      "A tiempo",
                    ],
                    [
                      "5",
                      "Dia tecnologico: Da Vinci",
                      "Auditorio",
                      "2024-01-05",
                      "Conoce al celebre robot Da Vinci",
                      "Cancelado",
                    ],
                    [
                      "7",
                      "Convivencia con RR.HH",
                      "RR.HH",
                      "2024-01-07",
                      "Convivencia con otras areas de Kokua: RR.HH",
                      "A tiempo",
                    ],
                    [
                      "8",
                      "Comida para los doctores",
                      "Comedor principal",
                      "2024-01-08",
                      "Comida para celebrar tu esfuerzo",
                      "Pospuesto",
                    ],
                  ];

                  const generateAvailableCard = (event) => {
                    const eventCard = document.createElement("div");
                    eventCard.id = "Evento-" + event[0];
                    eventCard.className = eventClassName;
                    eventCard.style =
                      "height: 330px;width: 300px;display: inline-block;";
                    eventCard.innerHTML = `
                                            <div class="scrollY1">
                                                <h4>${event[1]}</h4>
                                            </div>
                                            <br>
                                            <p><b>Lugar: </b>${event[2]}</p>
                                            <p><b>Fecha: </b>${event[3]}</p>
                                            <div class="scrollY2">
                                                <p><b>Descripcion:</b> ${event[4]}</p>
                                            </div>
                                            <p><b>Estatus: </b>${event[5]}</p>
                                            <button class="purpleButton" onClick="changeEventHandler(${event[0]})">Reservar</button>
                                        `;
                    return eventCard;
                  };
                  const generateMyCard = (event) => {
                    const eventCard = document.createElement("div");
                    eventCard.id = "Evento-" + event[0];
                    eventCard.className = eventClassName;
                    eventCard.style =
                      "height: 330px;width: 300px;display: inline-block;";
                    eventCard.innerHTML = `
                                            <div class="scrollY1">
                                                <h4>${event[1]}</h4>
                                            </div>
                                            <br>
                                            <p><b>Lugar: </b>${event[2]}</p>
                                            <p><b>Fecha: </b>${event[3]}</p>
                                            <div class="scrollY2">
                                                <p><b>Descripcion:</b> ${event[4]}</p>
                                            </div>
                                            <p><b>Estatus: </b>${event[5]}</p>
                                            <button class="purpleButton" onClick="cancelEventHandler(${event[0]})">Cancelar</button>
                                        `;
                    return eventCard;
                  };

                  //Getters a la BD
                  const getAvailableEvents = async () => {
                    try {
                      const endpoint = "/";
                      const response = await axios.get();
                    } catch (error) {
                      console.log("Error getting available events from server");
                    }
                  };
                  const getMyEvents = async () => {
                    try {
                      const endpoint = "/";
                      const response = await axios.get();
                    } catch (error) {
                      console.log("Error getting my events from server");
                    }
                  };

                  //Cargan los eventos en la pagina
                  const loadAvailableEvents = () => {
                    availableEvents.map((availableEvent) => {
                      const eventCard = generateAvailableCard(availableEvent);
                      availableEventsContainer.appendChild(eventCard);
                    });
                  };
                  const loadMyEvents = () => {
                    myEvents.map((myEvent) => {
                      const eventCard = generateMyCard(myEvent);
                      myEventsContainer.appendChild(eventCard);
                    });
                  };

                  //Permite cambiar un evento de disponible a mio
                  const changeEventHandler = async (id) => {
                    for (let i = 0; i < availableEvents.length; i++) {
                      if (availableEvents[i][0] == id) {
                        const eventCard = document.getElementById(
                          "Evento-" + id
                        );
                        availableEventsContainer.removeChild(eventCard);
                        const newCard = generateMyCard(availableEvents[i]);
                        myEventsContainer.appendChild(newCard);
                        myEvents.push(availableEvents[i]);

                        let aux = [];
                        for (let j = 0; j < availableEvents.length; j++) {
                          if (j != i) {
                            aux.push(availableEvents[j]);
                          }
                        }
                        availableEvents = aux;
                        break;
                      }
                    }
                  };

                  //Permite cancelar la asistencia
                  const cancelEventHandler = async (id) => {
                    for (let i = 0; i < myEvents.length; i++) {
                      if (myEvents[i][0] == id) {
                        const eventCard = document.getElementById(
                          "Evento-" + id
                        );
                        myEventsContainer.removeChild(eventCard);
                        const newCard = generateAvailableCard(myEvents[i]);
                        availableEventsContainer.appendChild(newCard);
                        availableEvents.push(myEvents[i]);

                        let aux = [];
                        for (let j = 0; j < myEvents.length; j++) {
                          if (j != i) {
                            aux.push(myEvents[j]);
                          }
                        }
                        myEvents = aux;

                        break;
                      }
                    }
                  };

                  const eventInitFunc = async () => {
                    //await getAvailableEvents()
                    //await getMyEvents()

                    loadAvailableEvents();
                    loadMyEvents();
                  };

                  eventInitFunc();
                </script>
              </div>
              <br />
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--Fin de la seccion 1-->

    <!--Seccion 2 de navegacion-->
    <div class="main-content">
      <!--Pacientes-->
      <div id="patients" class="content">
        <div class="main">
          <div class="row">
            <div class="col-sm-12 text-left">
              <h1>
                <ion-icon name="people-circle-outline"></ion-icon>
                Mis pacientes
              </h1>
              <p>Hola Doctor, aquí se muestran tus pacientes.</p>
              <br />

              <h3>
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
                Mis chats
              </h3>

              <div
                id="myPatients"
                class="chat-list"
                style="width: 400px; height: 400px; overflow-y: scroll"
              >
                <!--Get patients and create containers for each one-->
                <script>
                  const doctorPatients = [
                    ["0123", "Roberto", "Martinez", "Cancer", "Etapa 1"],
                    ["0124", "Jorge", "Martinez", "Hepatitis", "Curado"],
                    [
                      "0125",
                      "Daniela",
                      "Martinez",
                      "Hipertension",
                      "En revision",
                    ],
                  ]; //Falta fetch de los pacientes
                  const clientContainerClass = "chat-box";

                  const loadPatients = (patients) => {
                    const container = document.getElementById("myPatients");

                    for (let i = 0; i < patients.length; i++) {
                      const patientDiv = document.createElement("div");
                      patientDiv.className = clientContainerClass;
                      patientDiv.innerHTML = `
                                            <div class="chat-details">
                                                <div class="text-head">
                                                    <h4> ${
                                                      patients[i][1] +
                                                      " " +
                                                      patients[i][2]
                                                    } </h4>
                                                    <p class="time unread">11:49</p>
                                                </div>
                                                <div class="text-message">
                                                    <p>${
                                                      patients[i][3] +
                                                      ": " +
                                                      patients[i][4]
                                                    }</p>
                                                </div>
                                            </div>
                                            `;
                      container.appendChild(patientDiv);
                    }
                  };

                  loadPatients(doctorPatients);
                </script>
              </div>

              <div></div>
            </div>
          </div>
        </div>
      </div>

      <!--Progreso medico-->
      <div id="update" class="content">
        <div class="main">
          <div class="row">
            <div class="col-sm-12 text-left">
              <h1>Progreso medico</h1>
              <div class="patientList">
                <div class="contenedor-items" id="contenedor-items-i">
                  <script>
                    async function loadJSON(url) {
                      return fetch(url)
                        .then((response) => {
                          if (!response.ok) {
                            throw new Error(`Error de red: ${response.status}`);
                          }
                          return response.json();
                        })
                        .catch((error) => {
                          console.error(
                            `Error al cargar JSON desde ${url}:`,
                            error
                          );
                          throw error; // Relanzar el error para manejo posterior si es necesario
                        });
                    }

                    const VerPacientes = async () => {
                        const Area = document.getElementById("contenedor-items-i"); // Asegúrate de que este es el ID correcto
                        Area.style.display = 'flex'; // Asegúrate de que este contenedor se muestre inicialmente
                      const urlPacientes = "/api/doctor/patients/:id";
                      const idDoctor = 2;
                      const newVerURL = urlPacientes.replace(":id", idDoctor);
                      const respuesta = await loadJSON(newVerURL);
                      const JSONPacientes = respuesta.data;
                      JSONPacientes.map((element) => {
                        const div = document.createElement("div");
                        div.innerHTML = `
                        <div class="item" data-idpaciente="${element.IDPaciente}">
                          <span class="titulo-item">${element.Nombre}</span>
                          <img src="img/profileICON.jpg" alt="" class="img-item">
                          <a class="enlace" onclick="seguimientoLoad(${element.IDPaciente})">View Info</a>
                          <button class="boton-item" onclick="loadFormPage(${element.IDPaciente})">Update Clinical Record</button>
                        </div>
                                        `;
                        Area.appendChild(div);
                      });
                    };

                    VerPacientes();
                  </script>
                </div>
              </div>

              <!---Fórmulario para actualizar el historial clinico del paciente-->
              <form class="crecord-form" id = 'rec-form'>
                <input type="hidden" id="form-paciente-id" name="pacienteId">
                <button onclick="returnPatients()">Regresar</button>
                <fieldset>
                  <legend>Recetas</legend>
                  <label for="medicamento">Nombre de medicina:</label>
                  <input
                    type="text"
                    id="medicamento"
                    name="medicamento"
                    required
                  />

                  <!-- Dosis -->
                  <label for="dosage">Dosis:</label>
                  <input type="text" id="dosis" name="dosis" required />

                  <label for="initial-date">Fecha:</label>
                  <input
                    type="date"
                    id="initial-date"
                    name="initial-date"
                    required
                  />
                </fieldset>

                <fieldset>
                  <legend>Diagnóstico</legend>

                  <label for="descripcionDiagnostico"
                    >Diagnoses Description:</label
                  >
                  <textarea
                    id="descripcionDiagnostico"
                    name="descripcionDiagnostico"
                    rows="4"
                    cols="50"
                    required
                  ></textarea>

                  <label for="estudiosRequeridos"> Required Test:</label>
                  <textarea
                    id="estudiosRequeridos"
                    name="estudiosRequeridos"
                    rows="4"
                    cols="50"
                    required
                  ></textarea>
                </fieldset>

                <fieldset>
                  <legend>TestResults</legend>
                  <label for="studySelect"
                    >Select Chronic Diseases Study:</label
                  >
                  <select id="studySelect" name="studySelect" required>
                    <option value="" disabled selected>Select a Study</option>
                    <option value="X-RAY">X-RAY</option>
                    <option value="EKG">EKG</option>
                    <option value="RM">RM</option>
                    <option value="TM">TM</option>
                    <option value="BloodAnalysis">Blood Tests</option>
                    <option value="EPOC">EPOC</option>
                    <option value="Ecografia">Ultrasound</option>
                    <option value="Holter">Holter Monitory</option>
                    <option value="Mamografia">Mammography</option>
                    <option value="Colonoscopia">Colonoscopy</option>
                  </select>

                  <label for="anotaciones"> Observations:</label>
                  <textarea
                    id="anotaciones"
                    name="anotaciones"
                    rows="4"
                    cols="50"
                    required
                  ></textarea>
                </fieldset>

                <button type="button" onclick="saveProfile()">
                  Guardar Cambios
                </button>
                <button type="button" class="cancel" onclick="cancelEdit()">
                  Cancelar
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!--Informacion-->
      <div id = "infoPatient">
        <script>
 
        </script>
      </div>
      <!--Perfil-->
          <!--Perfil-->
          <div id="profile" class="content">
            <div class="main">
              <div class="row">
                <div class="col-sm-12 text-left">
                  <h1>
                    <ion-icon name="person-circle-outline"></ion-icon>Mi perfil
                  </h1>
                  <div class="profile-info">
                    <div class="profile-image-container">
                      <img
                        class="profile-image"
                        src="https://media.licdn.com/dms/image/C4E03AQHN8xgseevCiA/profile-displayphoto-shrink_800_800/0/1516517482014?e=2147483647&v=beta&t=j98hf-SQssBnepwI5c5S7tFsnoleqeiJuycdDPcVGrc"
                        alt="Doctor Profile"
                      />
                    </div>
                    <div class="profile-details" id="profileInfo">
                      <script>
                        async function loadJSON(url) {
                          return fetch(url)
                            .then((response) => {
                              if (!response.ok) {
                                throw new Error(`Error de red: ${response.status}`);
                              }
                              return response.json();
                            })
                            .catch((error) => {
                              console.error(
                                `Error al cargar JSON desde ${url}:`,
                                error
                              );
                              throw error; // Relanzar el error para manejo posterior si es necesario
                            });
                        }
    
                        const loadProfile = async () => {
                          const urlPacientes = "/api/doctor/patients/:id";
                          const idDoctor = 2;
                          const newVerURL = urlPacientes.replace(":id", idDoctor);
                          const respuesta = await loadJSON(newVerURL);
                          const JSONPacientes = respuesta.data;
    
                          const area = document.getElementById("profileInfo");
                          const URL = "/api/doctor/profile/:id";
                          const idDoc = 2;
                          const newURL = URL.replace(":id", idDoc);
                          const resp = await loadJSON(newURL);
                          const jsonDoc = resp.data;
                          const div = document.createElement("div");
                          div.innerHTML = `
                                        <p><strong>Nombre:</strong> ${jsonDoc[0].Nombre} ${jsonDoc[0].Apellido}</p>
                                        <p><strong>Fecha de Nacimiento:</strong> ${jsonDoc[0].FechaNacimiento}</p>
                                        <p><strong>Doctorado:</strong> Especialidad en ${jsonDoc[0].Especialidad}</p>
                                        <p><strong>Número de pacientes tratados:</strong> ${JSONPacientes.length}</p>
                                        <p><strong>Cedula profesional:</strong> ${jsonDoc[0].CedulaProfesional}</p>
                                        `;
                          area.appendChild(div);
                        };
                        loadProfile();
                      </script>
                    </div>
                  </div>
                  <button onclick="editProfile()">Editar Perfil</button>

              <!-- Formulario de edición de perfil -->
              <form class="profile-form">
                <label for="nombre">Nombre:</label>
                <input
                  type="text"
                  id="nombre"
                  name="nombre"
                  value="Dr. Nombre Apellido"
                />

                <label for="fecha-nacimiento">Fecha de Nacimiento:</label>
                <input
                  type="date"
                  id="fecha-nacimiento"
                  name="fecha-nacimiento"
                  value="1988-01-01"
                />

                <label for="doctorado">Doctorado:</label>
                <input
                  type="text"
                  id="doctorado"
                  name="doctorado"
                  value="Especialidad en..."
                />

                <label for="num-pacientes">Número de pacientes tratados:</label>
                <input
                  type="text"
                  id="num-pacientes"
                  name="num-pacientes"
                  value="200"
                />

                <label for="lugar-atencion">Lugar de atención:</label>
                <input
                  type="text"
                  id="lugar-atencion"
                  name="lugar-atencion"
                  value="Hospital XYZ"
                />

                <label for="estudios">Estudios:</label>
                <input
                  type="text"
                  id="estudios"
                  name="estudios"
                  value="Universidad ABC, Año de graduación"
                />

                <label for="imagen-perfil">Foto de Perfil:</label>
                <input
                  type="file"
                  id="imagen-perfil"
                  name="imagen-perfil"
                  accept="image/*"
                  onchange="previewImage()"
                />

                <div class="profile-image-container">
                  <img
                    class="profile-image"
                    id="preview"
                    alt="Vista previa de la imagen"
                  />
                </div>

                <button type="button" onclick="saveProfile(),returnPatients()">
                  Guardar Cambios
                </button>
                <button type="button" class="cancel" onclick="cancelEdit()">
                  Cancelar
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--Fin de la seccion 2-->

    <!--Seccion 3 de navegacion-->
    <div class="main-content">
      <!--Cerrar sesion-->
      <div id="log-out" class="content">
        <div class="main">
          <div class="row">
            <div class="col-sm-6 text-center">
              <h4 class="display-4" style="font-weight: lighter">
                Hasta luego doctor
              </h4>
              <br />
              <div
                class="jumbotron p-4 mx-auto w-50"
                style="background-color: #6275e6; color: #fff"
              >
                <h1>Esperamos contar de nuevo con su ayuda</h1>
              </div>
              <br />
            </div>
            <div style="height: 800px; width: 400px">
              <img
                src="https://static.vecteezy.com/system/resources/previews/003/462/807/non_2x/one-line-drawing-of-children-giving-love-heart-shaped-vector.jpg"
                class="imgDoctor img-fluid"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--Fin de la seccion 3-->

    <!-- Seccion de funciones de JS -->
    <script>
               function loadJSON(url) {
            return fetch(url)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`Error de red: ${response.status}`);
                }
                return response.json();
              })
              .catch(error => {
                console.error(`Error al cargar JSON desde ${url}:`, error);
                throw error; // Relanzar el error para manejo posterior si es necesario
              });
          }
          const seguimientoLoad = async(idPaciente) =>{
            const updateseguimientoURL = `/api/paciente/Seguimiento${idPaciente}`;
            const response = await loadJSON(updateseguimientoURL);
            const jsonSeguimiento = response.data;

            const areaVerPacientes = document.getElementById('contenedor-items-i'); 
            const areaInfoPaciente = document.getElementById('infoPatient');
            const rec = arearec = document.getElementById('rec-form');
            
            // Ocultar VerPacientes y mostrar infoPatient
            areaVerPacientes.style.display = 'none';
            areaInfoPaciente.style.display = 'block';
            rec.style.display = 'none';
            areaInfoPaciente.innerHTML = ''; // Limpiar contenido anterior

            // Construir el contenido para el paciente específico
            const div = document.createElement('div');
     // Botón de regreso
            const botonRegresar = document.createElement('button');
            botonRegresar.innerText = 'Regresar';
            botonRegresar.style.padding = '10px'; 
            botonRegresar.style.backgroundColor = 'blue'; 
            botonRegresar.style.borderRadius = '10px';
            botonRegresar.onclick = () => {
              areaInfoPaciente.style.display = 'none'; // Ocultar información del paciente
              areaVerPacientes.style.display = 'flex'; // Mostrar lista de pacientes
              rec.style.display = 'none';
            };

  areaInfoPaciente.appendChild(botonRegresar);
          div.innerHTML = `
          <div class = 'row'>
            <div class="col-lg-4">
              <div id="patientInfo" class="info-container">
              <ion-icon name="medkit" class="icono-grande"></ion-icon>
                
                <div class="texto-info">
                  <p>Doctor:</p>
                  <h6>${jsonSeguimiento[0].NombreDoctor}</h6>
                </div>
              </div>
          </div>
          
          <div class="col-lg-4">
            <div id="patientInfo" class="info-container">
              
              <ion-icon name="people" class="icono-grande"></ion-icon>
              <div class="texto-info">
                <p>Persona de Apoyo:</p>
                <h6>${jsonSeguimiento[0].NombrePersonaApoyo}</h6>  
              </div>
            </div>
          </div>

          
          <div class="col-lg-4">
            <div id="patientInfo" class="info-container">
            <ion-icon name="medical" class="icono-grande"></ion-icon>
              <div class="texto-info">
                <p>Aseguradora:</p>
                <h6>${jsonSeguimiento[0].NombreAseguradora}</h6> 
              </div>
            </div>
          </div>

          </div>
            <br>
            <h2>Mis citas</h2>
            <div id = 'CitasArea'></div>
            <br>
            <h2>Mis medicamentos</h2>
            <div id='MedicamentosArea'></div>
            <br>
          `
          areaInfoPaciente.appendChild(div);
          const medicinasArea = document.getElementById('MedicamentosArea'); 
          const citasArea = document.getElementById('CitasArea');
          // Crear contenedor para la línea de tiempo
          // Crear contenedor para la línea de tiempo
          // Crear contenedor para la línea de tiempo
          const lineaTiempoContainer = document.createElement('div');
          lineaTiempoContainer.className = 'linea-tiempo-container';
        
          const fechasUnicas = new Set();
          jsonSeguimiento.forEach(el => {
            // Formatea la fecha para mostrar solo aaaa-mm-dd
            const fechaFormateada = el.FechaCita.split('T')[0];
        
            if (!fechasUnicas.has(fechaFormateada)) {
              fechasUnicas.add(fechaFormateada);
        
              const puntoLineaTiempo = document.createElement('div');
              puntoLineaTiempo.className = 'punto-linea-tiempo';
        
              const labelFecha = document.createElement('div');
              labelFecha.className = 'label-fecha';
              labelFecha.innerText = fechaFormateada;
              puntoLineaTiempo.appendChild(labelFecha);
              lineaTiempoContainer.appendChild(puntoLineaTiempo);
            }
          });
          
          
          const titLinea = document.createElement('h3');
          titLinea.innerText = "Linea del tiempo citas: "
          citasArea.appendChild(titLinea);
          citasArea.appendChild(lineaTiempoContainer);

          

          const tablaCitas = document.createElement('table');
          const citasUnicas = new Set();
          tablaCitas.className = 'tabla-citas'; // Añade una clase para estilos CSS si es necesario

          // Añadir cabecera de la tabla
          const cabeceraTabla = document.createElement('thead');
          cabeceraTabla.innerHTML = `
            <tr>
              <th>Fecha de la Cita</th>
              <th>Tipo de Cita</th>
              <th>Estatus de la Cita</th>
            </tr>`;
          tablaCitas.appendChild(cabeceraTabla);

          // Añadir cuerpo de la tabla
          const cuerpoTabla = document.createElement('tbody');
          jsonSeguimiento.forEach(el => {
            // Formatea la fecha para mostrar solo aaaa-mm-dd
            const fechaFormateada = el.FechaCita.split('T')[0];
          
            const citaKey = `${fechaFormateada}-${el.TipoCita}-${el.EstatusCita}`;
          
            if (!citasUnicas.has(citaKey)) {
              citasUnicas.add(citaKey);
          
              const filaTabla = document.createElement('tr');
              filaTabla.innerHTML = `
                <td>${fechaFormateada}</td>
                <td>${el.TipoCita}</td>
                <td>${el.EstatusCita}</td>
              `;
              cuerpoTabla.appendChild(filaTabla);
            }
          });
          tablaCitas.appendChild(cuerpoTabla);
          const titTabla = document.createElement('h3');
          titTabla.innerText = "Tabla de citas: "
          citasArea.appendChild(titTabla);
          citasArea.appendChild(tablaCitas);
          console.log(jsonSeguimiento);

        const medicinasUnicas = new Set();
        jsonSeguimiento.forEach(el => {
          if (!medicinasUnicas.has(el.NombreMedicina)) {
            medicinasUnicas.add(el.NombreMedicina);

            const tarjetaMedicina = document.createElement('div');
            tarjetaMedicina.className = 'tarjeta-medicina';

            const nombreMedicina = document.createElement('h5');
            nombreMedicina.innerText = `Nombre: ${el.NombreMedicina}`;
            
            const descripcionMedicina = document.createElement('p');
            descripcionMedicina.innerText = `Descripción: ${el.Indicaciones}`;

            tarjetaMedicina.appendChild(nombreMedicina);
            tarjetaMedicina.appendChild(descripcionMedicina);

            medicinasArea.appendChild(tarjetaMedicina);
          }
        });
      }
      
      // Script para manejar el cambio de hash y mostrar/ocultar el contenido correspondiente
      document.addEventListener("DOMContentLoaded", function () {
        
        // Manejar el cambio de hash
        window.addEventListener("hashchange", function () {
          // Ocultar todos los contenidos
          var contents = document.querySelectorAll(".content");
          contents.forEach(function (content) {
            content.style.display = "none";
          });

          // Mostrar el contenido correspondiente al hash actual
          var currentHash = window.location.hash.substring(1);
          var currentContent = document.getElementById(currentHash);
          if (currentContent) {
            currentContent.style.display = "block";
          }
        });

        // Simular el evento hashchange al cargar la página
        var hashChangeEvent = new Event("hashchange");
        window.dispatchEvent(hashChangeEvent);
      });

      function editProfile() {
        // Oculta la información y muestra el formulario de edición
        document.querySelector(".profile-info").style.display = "none";
        document.querySelector(".profile-form").style.display = "block";
      }
      async function agregarReceta(datosCita) {
          try {
            const response = await fetch('/api/doctor/seguimiento/newReceta', {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(datosCita),
            });

            if (!response.ok) {
              throw new Error(
                `HTTP error! status: ${response.status}`
              );
            }

            const data = await response.json();
            console.log(
              "Cita agregada con éxito, ID:",
              data.insertedId
            );
            return data.insertedId; // Devolver el ID de la cita insertada
          } catch (error) {
            console.error("Error al agregar la cita:", error);
          }
        }

      async function saveProfile() {
        // Recoger los valores de los campos del formulario
        const medicamento = document.getElementById('medicamento').value;
        const dosis = document.getElementById('dosis').value;
        const initialDate = document.getElementById('initial-date').value;
        const descripcionDiagnostico = document.getElementById('descripcionDiagnostico').value;
        const estudiosRequeridos = document.getElementById('estudiosRequeridos').value;
        const studySelect = document.getElementById('studySelect').value;
        const anotaciones = document.getElementById('anotaciones').value;
        const URLMed = `/api/doctor/medicina/${medicamento}`
        const resp = await loadJSON(URLMed); 
        const jsonMed = resp.data;
      // Enviar los datos a donde corresponda (base de datos, servidor, etc.)
        document.querySelector(".profile-info").style.display = "flex";
        document.querySelector(".profile-form").style.display = "none";
        const idPaciente = document.getElementById('form-paciente-id').value;
        const url = `/api/paciente/appointments/${idPaciente}`;
        const response = await loadJSON(url);
        const citasPersona = response.data; 
        for (const el of citasPersona) {
          if (el.EstatusCita === 'Agendada') {
            const URLMed = `/api/doctor/medicina/${medicamento}`;
            const resp = await loadJSON(URLMed);
            const jsonMed = resp.data;
            console.log(`ID de la medicina ${jsonMed[0].IDMedicina}`);

            const JSON = {
              IDCita: el.IDCita,
              IDMedicina: jsonMed[0].IDMedicina,
              CantidadDiaria: dosis,
              Indicaciones: anotaciones,
              Diagnostico: descripcionDiagnostico,
              NombreMedicina: medicamento
            };
            console.log(JSON);

            await agregarReceta(JSON);
            document.querySelector(".patientList").style.display = "flex";
            const rec = document.getElementById('rec-form');
            rec.style.display = 'none';

         }
       }
      }

      function cancelEdit() {
        document.querySelector(".patientList").style.display = "flex";
        const rec = document.getElementById('rec-form');
        rec.style.display = 'none';
      }

      function loadFormPage(idPaciente) {
        document.querySelector(".patientList").style.display = "none";
        const rec = document.getElementById('rec-form');
        rec.style.display = 'block';
        document.getElementById('form-paciente-id').value = idPaciente;
      }

      function returnPatients(){
        document.querySelector(".patientList").style.display = "flex";
        const rec = document.getElementById('rec-form');
        rec.style.display = 'none';
        
        // Resetear el valor del campo oculto
        document.getElementById('form-paciente-id').value = '';
      }

      function previewImage() {
        // Muestra la vista previa de la imagen seleccionada
        var input = document.getElementById("imagen-perfil");
        var preview = document.getElementById("preview");

        var reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
        };
      }
  
    
    </script>
  </body>
</html>
